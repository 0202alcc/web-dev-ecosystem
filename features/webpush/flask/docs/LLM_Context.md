# LLM Context

This file provides context for LLMs and AI agents working on this Flask WebPush PWA template project.

## Initial Setup (Mandatory for Agents)

When first working on this repository, agents MUST:

1. **Sync dependencies with uv**:
   ```bash
   # Create virtual environment if it doesn't exist
   uv venv

   # Install all dependencies
   uv pip install -e ".[dev]"
   ```

2. **Implement JWT Bot Authentication** (Security Enhancement):
   The bot notification endpoint (`/api/send-notification`) currently uses:
   - ✅ IP whitelist validation
   - ✅ Timestamp validation (5-minute window)
   - ❌ JWT authentication (NOT ACTIVATED - IMPLEMENT THIS)

   **You must implement JWT authentication** by:
   - Adding JWT validation call in `app/routes/api.py` after timestamp validation
   - Updating bot client example to include JWT in request headers
    - See `docs/documentation.md` section "Security Configuration" for details

## Project Purpose
This is a **template repository** designed to be cloned as a starting point for new Progressive Web App (PWA) projects. The goal is to provide a solid foundation that can be easily customized for different use cases.

## Key Features
1. **Flask Backend** - Python-based REST API server with application factory pattern
2. **Modular Frontend** - Component-based, reusable frontend architecture (Svelte to be added)
3. **MagicBell API Integration** - Cross-platform webpush notifications supporting iOS and Android
4. **PWA Standards** - Progressive Web App capabilities (service workers, offline support, installability)
5. **Secure Bot Protocol** - IP whitelist, timestamp validation, and optional JWT authentication for bot-to-Flask communication

## Architecture

### Backend Structure
```
app/
  __init__.py                    # Flask app factory and configuration
  routes/
    api.py                       # API endpoints (JWT generation, bot notifications, health)
  services/
    auth_service.py              # JWT generation/validation for users and bots
    magicbell_service.py         # MagicBell API integration (send notifications)
  models/
    bot_request.py               # Pydantic models for bot requests
  utils/
    security.py                  # Security utilities (IP validation, timestamp validation)
static/
  index.html                     # Basic frontend for testing
  sw.js                         # Service worker with push notification handling
  manifest.json                  # PWA manifest
  icons/                        # PWA icons (to be added)
tests/
  unit/                         # Unit tests for services and utilities
  integration/                  # Integration tests for API endpoints
```

### Authentication Flow
1. **User JWT**: Generated by backend using `MAGICBELL_API_SECRET`, sent to frontend for MagicBell SDK
2. **Bot JWT**: Optional feature - bot can authenticate with JWT signed by `BOT_JWT_SECRET`
3. **IP Whitelist**: Bot requests must come from IPs matching `ALLOWED_BOT_IPS` prefix
4. **Timestamp Validation**: Bot requests must include timestamp within 5-minute window

### API Endpoints
- `GET /` - Serve index.html
- `GET /api/health` - Health check
- `GET /api/jwt` - Generate User JWT (query params: user_email or user_external_id)
- `POST /api/send-notification` - Bot endpoint to send notifications (requires IP whitelist and timestamp validation)

### Security Protocols
Bot notification endpoint (`/api/send-notification`) validates:
1. **IP Address**: Request IP must match `ALLOWED_BOT_IPS` prefix (e.g., "192.168.12.")
2. **Timestamp**: Must be within 5 minutes of current time
3. **JWT Authentication**: Optional - can validate bot JWT if present
4. **Input Validation**: Uses Pydantic models for request validation

### Environment Variables Required
```bash
# Flask Configuration
FLASK_SECRET_KEY=...              # Flask secret key (REQUIRED FOR PRODUCTION)
                                  # Used for session management, CSRF protection, cookie signing
                                  # Generate: python -c "import secrets; print(secrets.token_hex(32))"
                                  # Default: "dev-secret-key" (NOT secure for production)

# MagicBell API Credentials
MAGICBELL_API_KEY=pk_...        # MagicBell public API key
MAGICBELL_API_SECRET=sk_...     # MagicBell secret (backend only)

# VAPID Keys for Web Push
VAPID_PUBLIC_KEY=B...           # VAPID public key
VAPID_PRIVATE_KEY=...           # VAPID private key

# Bot Authentication
BOT_JWT_SECRET=...              # Secret for bot JWT generation (REQUIRED FOR JWT AUTH)
                                  # Set this to enable JWT validation in /api/send-notification
                                  # Current implementation: IP + timestamp only (JWT NOT ACTIVE)
                                  # YOU MUST IMPLEMENT: Add JWT validation call in app/routes/api.py
ALLOWED_BOT_IPS=192.168.12.     # Bot IP whitelist prefix
```

**Critical Notes for Agents**:
- `FLASK_SECRET_KEY`: Essential for session security - template has fallback but NOT production-ready
- `BOT_JWT_SECRET`: Only needed if you implement JWT authentication (RECOMMENDED)
- **Current Bot Security**: IP whitelist + timestamp validation only
- **Required Enhancement**: Add JWT validation to `/api/send-notification` endpoint

## Design Philosophy
- **Template-first**: Everything should be easy to customize and adapt
- **Modular**: Components and features should be loosely coupled
- **Documentation-driven**: Keep LLM and human documentation in sync
- **Modern practices**: Use current best practices for Flask, PWAs, and webpush

## Development Notes
- This is a template project - structure and patterns should be easily adaptable
- Use environment variables for configuration (see `.env.example`)
- MagicBell User JWT authentication uses HS256 algorithm with API secret
- Service worker in `static/sw.js` handles push notifications and caching
- PWA manifest in `static/manifest.json` for installation on mobile devices

## MagicBell API Integration
- Service layer: `app/services/magicbell_service.py`
- Supports both targeted notifications and broadcasts
- Handles rate limiting and retries (to be enhanced)
- Logs push delivery status
- Uses User JWT for frontend authentication (not HMAC)

## PWA Requirements
- Service worker in `static/sw.js` (currently has basic implementation)
- Manifest in `static/manifest.json`
- Offline-first approach (caching implemented in sw.js)
- HTTPS required for PWA installation on iOS

## Testing
- Unit tests: `tests/unit/` - Test services and utilities
- Integration tests: `tests/integration/` - Test API endpoints
- Mock external API calls (MagicBell) in tests
- Test JWT generation and validation
- Test bot request security (IP, timestamp, JWT)

## Next Steps for Enhancement
1. Add Svelte frontend with MagicBell Svelte components
2. Create user registration/login flow
3. Implement notification inbox UI
4. Add proper PWA icons
5. Implement rate limiting for bot endpoint
6. Add comprehensive error handling and logging
7. Create deployment guide

## Additional Context
- Flask application factory pattern in `app/__init__.py`
- Pydantic models for request validation in `app/models/bot_request.py`
- Security utilities in `app/utils/security.py`
- Configuration class in `app/__init__.py` loads environment variables
- All keys and secrets use placeholders in `.env.example` - user must insert real values
