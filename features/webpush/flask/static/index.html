<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flask WebPush PWA</title>
    <link rel="manifest" href="/static/manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: #ffffff;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 60px;
        }

        .notification-control {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .notification-control label {
            font-size: 18px;
            color: #333;
            font-weight: 500;
            cursor: pointer;
        }

        .test-button {
            margin-top: 20px;
            padding: 12px 32px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .test-button:hover {
            background: #1976D2;
        }

        .test-button:active {
            background: #1565C0;
        }

        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .ios-note {
            margin-top: 30px;
            padding: 12px 20px;
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            font-size: 13px;
            color: #856404;
            max-width: 500px;
            text-align: center;
            display: none;
        }

        .ios-note.show {
            display: block;
        }

        /* Toggle Switch Styling */
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 34px;
            display: inline-block;
        }

        .toggle-switch input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            margin: 0;
            cursor: pointer;
            z-index: 2;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 34px;
            pointer-events: none;
            z-index: 1;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #4CAF50;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        input:disabled + .slider {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .toggle-switch input:disabled {
            cursor: not-allowed;
        }

        /* Footer Styling */
        footer {
            padding: 15px 20px;
            background: #f5f5f5;
            border-top: 1px solid #e0e0e0;
        }

        .debug-info {
            font-size: 10px;
            color: #666;
            line-height: 1.4;
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
        }

        .debug-info .section {
            display: flex;
            align-items: center;
            white-space: nowrap;
        }

        .debug-info .label {
            font-weight: 600;
            color: #333;
            margin-right: 5px;
        }

        .debug-info .value {
            color: #666;
            font-family: 'Courier New', monospace;
        }

        .debug-info .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .debug-info .status-indicator.green {
            background-color: #4CAF50;
        }

        .debug-info .status-indicator.red {
            background-color: #f44336;
        }

        .debug-info .status-indicator.yellow {
            background-color: #ff9800;
        }

        @media (max-width: 768px) {
            .debug-info {
                font-size: 9px;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="main-content">
        <div class="notification-control">
            <label for="notificationToggle">Enable notifications:</label>
            <div class="toggle-switch">
                <input type="checkbox" id="notificationToggle">
                <span class="slider"></span>
            </div>
        </div>
        <button id="testNotification" class="test-button" style="display: none;">
            Send Test Notification
        </button>
        <div class="ios-note" id="iosNote">
            <strong>ðŸ“± iOS Testing Note:</strong> For push notifications to work on iOS, you must:
            (1) Use Safari browser,
            (2) Add this site to your Home Screen,
            (3) Use HTTPS (not localhost).
        </div>
    </div>

    <footer>
        <div class="debug-info">
            <div class="section">
                <span class="status-indicator" id="apiStatus"></span>
                <span class="label">API Status:</span>
                <span class="value" id="apiStatusText">Checking...</span>
            </div>
            <div class="section">
                <span class="status-indicator" id="permissionStatus"></span>
                <span class="label">Notification Permission:</span>
                <span class="value" id="permissionStatusText">Unknown</span>
            </div>
            <div class="section">
                <span class="status-indicator" id="subscriptionStatus"></span>
                <span class="label">Push Subscription:</span>
                <span class="value" id="subscriptionStatusText">Not subscribed</span>
            </div>
            <div class="section">
                <span class="label">Service Worker:</span>
                <span class="value" id="swStatus">Not registered</span>
            </div>
            <div class="section">
                <span class="label">User ID:</span>
                <span class="value" id="userId">test@example.com</span>
            </div>
            <div class="section">
                <span class="label">VAPID Public Key:</span>
                <span class="value" id="vapidKey">Loading...</span>
            </div>
            <div class="section">
                <span class="label">Endpoint:</span>
                <span class="value" id="endpoint">http://localhost:3000</span>
            </div>
            <div class="section">
                <span class="label">Browser:</span>
                <span class="value" id="browserInfo">Detecting...</span>
            </div>
            <div class="section">
                <span class="label">PWA Mode:</span>
                <span class="value" id="pwaMode">No</span>
            </div>
        </div>
    </footer>

    <script>
        let currentSubscription = null;
        let userJWT = null;
        let vapidPublicKey = null;
        let userExternalId = null;

        // Generate or retrieve user external ID from localStorage
        function getUserExternalId() {
            let userId = localStorage.getItem('webpush_user_id');
            if (!userId) {
                // Generate UUID v4
                userId = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    const r = Math.random() * 16 | 0;
                    const v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
                localStorage.setItem('webpush_user_id', userId);
            }
            return userId;
        }

        // Detect iOS
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        }

        // Detect browser
        function getBrowserInfo() {
            const ua = navigator.userAgent;
            if (ua.indexOf('Safari') > -1 && ua.indexOf('Chrome') === -1) return 'Safari';
            if (ua.indexOf('Chrome') > -1) return 'Chrome';
            if (ua.indexOf('Firefox') > -1) return 'Firefox';
            return 'Unknown';
        }

        // Check if running as PWA
        function isPWA() {
            return window.navigator.standalone === true ||
                   window.matchMedia('(display-mode: standalone)').matches;
        }

        // Initialize on page load
        async function initialize() {
            // Get or generate user external ID
            userExternalId = getUserExternalId();
            document.getElementById('userId').textContent = userExternalId;

            // Update browser info in footer
            document.getElementById('browserInfo').textContent = getBrowserInfo() + (isIOS() ? ' (iOS)' : '');
            document.getElementById('pwaMode').textContent = isPWA() ? 'Yes' : 'No';
            document.getElementById('endpoint').textContent = window.location.origin;

            // Show iOS note if on iOS
            if (isIOS()) {
                document.getElementById('iosNote').classList.add('show');
            }

            await checkAPIHealth();
            await loadUserConfig();
            await registerServiceWorker();
            updatePermissionStatus();
            await checkExistingSubscription();
        }

        // Check API health
        async function checkAPIHealth() {
            const statusIndicator = document.getElementById('apiStatus');
            const statusText = document.getElementById('apiStatusText');

            try {
                const response = await fetch('/api/health');
                const data = await response.json();

                if (data.status === 'healthy') {
                    statusIndicator.className = 'status-indicator green';
                    statusText.textContent = 'Connected';
                } else {
                    statusIndicator.className = 'status-indicator yellow';
                    statusText.textContent = 'Unknown status';
                }
            } catch (error) {
                statusIndicator.className = 'status-indicator red';
                statusText.textContent = 'Disconnected';
                console.error('API health check failed:', error);
            }
        }

        // Load user configuration and JWT
        async function loadUserConfig() {
            try {
                const response = await fetch(`/api/jwt?user_external_id=${encodeURIComponent(userExternalId)}`);
                const data = await response.json();

                if (data.success) {
                    userJWT = data.token;
                    vapidPublicKey = data.vapid_public_key;
                    document.getElementById('vapidKey').textContent = vapidPublicKey.substring(0, 30) + '...';
                } else {
                    console.error('Failed to load user config:', data.error);
                    alert('Failed to load configuration: ' + data.error);
                }
            } catch (error) {
                console.error('Error loading user config:', error);
                alert('Error loading configuration: ' + error.message);
            }
        }

        // Register service worker
        async function registerServiceWorker() {
            const swStatus = document.getElementById('swStatus');

            if (!('serviceWorker' in navigator)) {
                swStatus.textContent = 'Not supported';
                return;
            }

            try {
                // Unregister any existing service workers first
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (let registration of registrations) {
                    await registration.unregister();
                }

                // Wait a bit for unregistration to complete
                await new Promise(resolve => setTimeout(resolve, 100));

                // Register new service worker
                const registration = await navigator.serviceWorker.register('/sw.js', {
                    scope: '/'
                });

                // Wait for service worker to be ready
                await navigator.serviceWorker.ready;
                swStatus.textContent = 'Registered';
            } catch (error) {
                swStatus.textContent = 'Registration failed';
                console.error('Service Worker registration failed:', error);
            }
        }

        // Update permission status display
        function updatePermissionStatus() {
            if (!('Notification' in window)) {
                return;
            }

            const statusIndicator = document.getElementById('permissionStatus');
            const statusText = document.getElementById('permissionStatusText');
            const permission = Notification.permission;

            if (permission === 'granted') {
                statusIndicator.className = 'status-indicator green';
                statusText.textContent = 'Granted';
            } else if (permission === 'denied') {
                statusIndicator.className = 'status-indicator red';
                statusText.textContent = 'Denied - Reset in browser settings';
            } else {
                statusIndicator.className = 'status-indicator yellow';
                statusText.textContent = 'Not requested';
            }
        }

        // Check for existing subscription
        async function checkExistingSubscription() {
            if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                return;
            }

            try {
                const registration = await navigator.serviceWorker.ready;
                const subscription = await registration.pushManager.getSubscription();

                if (subscription) {
                    currentSubscription = subscription;
                    updateSubscriptionStatus(true);
                    document.getElementById('notificationToggle').checked = true;
                }
            } catch (error) {
                console.error('Error checking subscription:', error);
            }
        }

        // Update subscription status display
        function updateSubscriptionStatus(subscribed) {
            const statusIndicator = document.getElementById('subscriptionStatus');
            const statusText = document.getElementById('subscriptionStatusText');
            const testButton = document.getElementById('testNotification');

            if (subscribed) {
                statusIndicator.className = 'status-indicator green';
                statusText.textContent = 'Subscribed';
                testButton.style.display = 'block';
            } else {
                statusIndicator.className = 'status-indicator red';
                statusText.textContent = 'Not subscribed';
                testButton.style.display = 'none';
            }
        }

        // Convert VAPID key
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/\-/g, '+')
                .replace(/_/g, '/');

            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);

            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        // Subscribe to push notifications
        async function subscribeToPush() {
            if (!vapidPublicKey) {
                alert('VAPID key not loaded. Please refresh the page.');
                return false;
            }

            if (!('Notification' in window)) {
                alert('Notifications are not supported in this browser.');
                return false;
            }

            if (!('PushManager' in window)) {
                alert('Push notifications are not supported in this browser.');
                return false;
            }

            try {
                const permission = await Notification.requestPermission();
                updatePermissionStatus();

                if (permission !== 'granted') {
                    alert('Notification permission was denied. Please enable notifications in your browser settings.');
                    return false;
                }

                const registration = await navigator.serviceWorker.ready;
                const subscribeOptions = {
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
                };

                const subscription = await registration.pushManager.subscribe(subscribeOptions);
                currentSubscription = subscription;

                // Register subscription with backend
                try {
                    const registerResponse = await fetch('/api/register-push-subscription', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            subscription: subscription.toJSON(),
                            user_external_id: userExternalId
                        })
                    });

                    const registerData = await registerResponse.json();
                    if (!registerData.success) {
                        console.error('Failed to register subscription:', registerData.error);
                        alert('Warning: Subscription created but not registered with server. You may not receive notifications.');
                    }
                } catch (error) {
                    console.error('Error registering subscription:', error);
                    alert('Warning: Failed to register with server. You may not receive notifications.');
                }

                updateSubscriptionStatus(true);
                return true;
            } catch (error) {
                console.error('Failed to subscribe to push notifications:', error);
                alert('Failed to enable notifications: ' + error.message);
                return false;
            }
        }

        // Unsubscribe from push notifications
        async function unsubscribeFromPush() {
            if (currentSubscription) {
                try {
                    await currentSubscription.unsubscribe();
                    currentSubscription = null;
                    updateSubscriptionStatus(false);
                    return true;
                } catch (error) {
                    console.error('Failed to unsubscribe:', error);
                    alert('Failed to unsubscribe: ' + error.message);
                    return false;
                }
            }
            return true;
        }

        // Handle toggle change
        const toggleElement = document.getElementById('notificationToggle');

        toggleElement.addEventListener('change', async (e) => {
            const toggle = e.target;

            if (toggle.checked) {
                toggle.disabled = true;
                const success = await subscribeToPush();
                toggle.disabled = false;

                if (!success) {
                    toggle.checked = false;
                }
            } else {
                toggle.disabled = true;
                const success = await unsubscribeFromPush();
                toggle.disabled = false;

                if (!success) {
                    toggle.checked = true;
                }
            }
        });

        // Handle test notification button
        document.getElementById('testNotification').addEventListener('click', async () => {
            const button = document.getElementById('testNotification');
            button.disabled = true;
            button.textContent = 'Sending...';

            try {
                // Send a local test notification (doesn't require server)
                const registration = await navigator.serviceWorker.ready;
                await registration.showNotification('Test Notification', {
                    body: 'This is a local test notification!',
                    icon: '/static/manifest.json',
                    badge: '/static/manifest.json',
                    vibrate: [200, 100, 200]
                });

                button.textContent = 'Sent!';
                setTimeout(() => {
                    button.textContent = 'Send Test Notification';
                    button.disabled = false;
                }, 2000);
            } catch (error) {
                console.error('Error sending test notification:', error);
                button.textContent = 'Error';
                alert('Error sending notification: ' + error.message);
                setTimeout(() => {
                    button.textContent = 'Send Test Notification';
                    button.disabled = false;
                }, 2000);
            }
        });

        // Initialize everything
        initialize();
    </script>
</body>
</html>
